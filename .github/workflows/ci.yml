name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  nix-checks:
    name: Nix Checks
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Run checks (clippy, fmt, test, doc)
        run: nix flake check -L

  # E2E security tests require kernel 6.12+ (Landlock ABI v5).
  # GHA ubuntu-latest currently ships 6.11; image 20260209 has 6.14 but hasn't propagated yet.
  # Uncomment when runners get kernel 6.12+.
  #
  # e2e:
  #   name: E2E (${{ matrix.distro }})
  #   runs-on: ubuntu-latest
  #   needs: nix-checks
  #   permissions:
  #     id-token: write
  #     contents: read
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       distro: [ubuntu:24.04, fedora:41, alpine:3.21]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: DeterminateSystems/determinate-nix-action@v3
  #     - uses: DeterminateSystems/magic-nix-cache-action@main
  #     - name: Build security test binary
  #       run: nix build -L .#security-test-bin
  #     - name: Run security tests in ${{ matrix.distro }}
  #       run: |
  #         TEST_BIN=$(realpath result/bin/security_tests-*)
  #         docker run --rm --privileged \
  #           -v /nix/store:/nix/store:ro \
  #           ${{ matrix.distro }} \
  #           "$TEST_BIN" --ignored --test-threads=1

  semver-check:
    name: SemVer Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          package: evalbox
